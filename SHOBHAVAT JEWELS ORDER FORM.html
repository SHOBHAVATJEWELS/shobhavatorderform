<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IIJS PREMIER 2025 - Shobhavat Jewels Order Form</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Updated font import for Dancing Script -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%; /* Ensure html and body take full height */
            overflow-x: hidden; /* Prevent horizontal scroll */
        }
        body {
            font-family: 'Inter', sans-serif;
            /* Gradient background - Updated to a more maroonish pink gradient */
            background: linear-gradient(to top left, #8B0000, #6A0000); /* Deeper maroon gradient */
            min-height: 100vh; /* Ensure full viewport height */
            display: flex;
            flex-direction: column; /* Allow content to stack vertically */
            align-items: center;
            justify-content: flex-start; /* Align content to the top */
        }
        /* Custom styles for better touch targets and overall aesthetics */
        .input-field, .select-field, .textarea-field {
            @apply w-full p-3 border border-gray-400 rounded-lg focus:ring-2 focus:ring-amber-300 focus:border-transparent transition duration-200 ease-in-out bg-white text-gray-800; /* Light background for input text */
        }
        .btn-primary {
            @apply bg-amber-600 hover:bg-amber-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out;
        }
        .btn-secondary {
            /* Adjusted for better contrast on dark background */
            @apply bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200 ease-in-out;
        }
        .btn-danger {
            @apply bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm transition duration-200 ease-in-out text-sm;
        }
        /* The main form container now takes up the full width/height and is transparent */
        .form-container {
            background-color: transparent; /* Make form background transparent to show body gradient */
            width: 100%; /* Full width */
            min-height: 100vh; /* Minimum full height to cover viewport */
            box-sizing: border-box; /* Include padding in width/height */
            padding: 1.5rem; /* Apply padding directly to the container */
            border-radius: 0; /* No rounded corners for full-page fit */
            box-shadow: none; /* Remove shadow if it's full page */
        }
        @media (min-width: 768px) { /* On larger screens, constrain max width for better readability */
            .form-container {
                max-width: 900px; /* Max width for content, but background still full page */
                min-height: 100vh; /* Keep min-height for larger screens too */
                margin: 0 auto; /* Center the content block horizontally */
                border-radius: 0; /* Still no border radius for full page */
                box-shadow: none; /* Still no shadow */
            }
        }

        .table-header {
            @apply text-left text-gray-200 font-semibold uppercase text-sm py-2; /* Lighter text for headers */
        }
        .table-cell {
            @apply py-2 border-b text-gray-100; /* Lighter text for cells */
            border-color: rgba(255, 255, 255, 0.2); /* Semi-transparent white border for contrast */
        }
        /* Added style for the vertical line */
        .border-right-gray {
            border-right: 1px solid rgba(255, 255, 255, 0.2); /* Semi-transparent white border for separation */
        }
        /* Styles for the company name and tagline, using Dancing Script for the main name */
        .company-name {
            font-family: 'Dancing Script', cursive; /* Elegant script font */
            color: #FFD700; /* Gold color from logo */
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); /* Stronger shadow for pop */
            font-size: 4.5rem; /* Increased size */
            line-height: 1; /* Adjust line height to prevent too much space */
            margin-bottom: 0; /* Remove default margin */
            text-transform: capitalize; /* Ensure script font looks natural */
        }
        .tagline {
            font-family: 'Inter', sans-serif; /* Keeping Inter for readability */
            color: #FFD700; /* Changed to gold color */
            margin-top: 0; /* Align closer to the company name */
            font-size: 1.125rem; /* text-lg */
        }
        /* Specific styling for the main form titles to ensure they are distinct */
        .event-title {
            font-family: 'Inter', sans-serif; /* Ensure Inter for this title */
            font-weight: 700; /* Bold */
            color: #F9FAFB; /* White for contrast on dark background */
            text-transform: uppercase; /* Ensure it's uppercase */
            font-size: 1.5rem; /* Reduced from 2rem */
            margin-bottom: 0; /* No margin bottom */
            line-height: 1.2; /* Adjust line height */
        }
        .form-subtitle {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            color: #F9FAFB; /* White for contrast on dark background */
            text-transform: uppercase;
            font-size: 1.25rem; /* Reduced from 1.5rem */
            margin-top: 0.5rem; /* Small margin top to separate from event title */
            margin-bottom: 1.5rem; /* mb-6 */
        }
        /* Adjusting client details and order items section headings */
        .client-section-title, .order-section-title {
            color: #F9FAFB; /* White for contrast */
        }
        /* Adjusting label colors */
        label {
            color: #D1D5DB; /* Light gray for labels */
        }
        /* Adjusting company info at bottom */
        .company-info-text {
            color: #E5E7EB; /* Light gray for company info text */
        }
        .company-info-link {
            color: #FBBF24; /* Amber/Gold for links */
        }

        /* Message box styles */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green for success */
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            text-align: center;
        }
        .message-box.error {
            background-color: #f44336; /* Red for error */
        }
        .message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div class="form-container">
        <!-- Company Name and Tagline -->
        <h1 class="text-center company-name">Shobhavat Jewels</h1>
        <p class="text-lg mb-6 text-center tagline">Timeless Treasures For The Modern Soul</p>

        <!-- Main Form Titles -->
        <h2 class="text-center event-title">IIJS PREMIER 2025</h2>
        <h3 class="text-center form-subtitle">Client Order Form</h3>


        <!-- Client Information Section -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4 client-section-title">Client Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="clientName" class="block text-sm font-medium mb-2">Client Name</label>
                    <input type="text" id="clientName" class="input-field" placeholder="Enter client's full name">
                </div>
                <div>
                    <label for="orderDate" class="block text-sm font-medium mb-2">Order Date</label>
                    <input type="date" id="orderDate" class="input-field" placeholder="DD MM YYYY">
                </div>
                <div>
                    <label for="requiredByDate" class="block text-sm font-medium mb-2">Required By Date</label>
                    <input type="date" id="requiredByDate" class="input-field" placeholder="DD MM YYYY">
                </div>
            </div>
        </div>

        <!-- Order Items Section -->
        <div class="mb-8">
            <h3 class="text-xl font-semibold mb-4 order-section-title">Order Items</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-transparent">
                    <thead>
                        <tr>
                            <th class="table-header border-right-gray pr-4">Category</th>
                            <th class="table-header pl-4">Jewellery No.</th>
                            <th class="table-header w-16"></th> <!-- For delete button -->
                        </tr>
                    </thead>
                    <tbody id="orderItemsTableBody">
                        <!-- Initial row for items -->
                        <tr class="item-row">
                            <td class="table-cell border-right-gray pr-4">
                                <select class="select-field item-category">
                                    <option value="">Select Category</option>
                                    <!-- Options populated by JS -->
                                </select>
                            </td>
                            <td class="table-cell pl-4">
                                <input type="text" class="input-field item-jewellery-no" placeholder="e.g., JWR001">
                            </td>
                            <td class="table-cell text-center">
                                <button type="button" class="btn-danger remove-item-btn">Remove</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button type="button" id="addItemBtn" class="btn-secondary mt-4 px-4 py-2 text-base">Add Item</button>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row justify-end gap-4">
            <button type="button" id="resetFormBtn" class="btn-secondary">Reset Form</button>
            <button type="button" id="viewOrdersBtn" class="btn-secondary">View Saved Orders</button>
            <button type="button" id="saveOrderBtn" class="btn-primary">Save Order</button>
            <button type="button" id="submitOrderBtn" class="btn-primary">Generate Order Summary</button>
        </div>

        <!-- Company Information (This section is for the live form display only) -->
        <div class="mt-8 pt-6 border-t border-gray-500 text-center company-info-text">
            <p class="text-sm">For inquiries, contact us:</p>
            <p class="text-md font-medium">Harish Jain: <a href="tel:+919820577028" class="company-info-link hover:underline">9820577028</a></p>
            <p class="text-md font-medium">Kishore Jain: <a href="tel:+919004548007" class="company-info-link hover:underline">9004548007</a></p>
            <p class="text-md font-medium">Mahipal Jain: <a href="tel:+919819656413" class="company-info-link hover:underline">9819656413</a></p>
            <p class="text-md font-medium">Email: <a href="mailto:shobhavatjewels@gmail.com" class="company-info-link hover:underline" id="companyEmailDisplay">shobhavatjewels@gmail.com</a></p>
            <p class="text-md font-medium">Instagram: <a href="https://instagram.com/shobhavatjewels" target="_blank" class="company-info-link hover:underline" id="companyInstagramDisplay">@shobhavatjewels</a></p>
            <!-- REMOVED COPYRIGHT LINE -->
        </div>

        <!-- Order Summary Modal (now also used for saved orders) -->
        <div id="orderSummaryModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-2xl relative">
                <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Order Summary</h2>
                <div id="modalContent" class="text-gray-700 space-y-2">
                    <!-- Summary details will be injected here -->
                </div>
                <div class="mt-6 text-right">
                    <button type="button" id="printOrderBtn" class="btn-primary">Print Order</button>
                </div>
            </div>
        </div>

        <!-- Saved Orders Modal -->
        <div id="savedOrdersModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-2xl relative">
                <button id="closeSavedOrdersModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Saved Orders</h2>
                <div id="savedOrdersList" class="text-gray-700 space-y-2 max-h-96 overflow-y-auto">
                    <!-- Saved orders will be listed here -->
                    <p class="text-center text-gray-500">Loading orders...</p>
                </div>
            </div>
        </div>

        <!-- Message Box for notifications -->
        <div id="messageBox" class="message-box"></div>

    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Function to display messages (success/error) - Moved to global scope for accessibility
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.classList.remove('success', 'error');
            if (isError) {
                messageBox.classList.add('error');
            } else {
                messageBox.classList.add('success');
            }
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        document.addEventListener('DOMContentLoaded', async () => {
            let app;
            let db;
            let auth;
            let userId = null;
            let firebaseInitialized = false; // Flag to track Firebase initialization status

            // Firebase Initialization
            // IMPORTANT: This configuration is specific to your Firebase project.
            // Do NOT share your API Key publicly in production applications.
            const firebaseConfig = {
                apiKey: "AIzaSyBquw94lNCFXDuZPZ_OazAuQw2fwaeguWw",
                authDomain: "shobhavat-jewels-order-form.firebaseapp.com",
                projectId: "shobhavat-jewels-order-form",
                storageBucket: "shobhavat-jewels-order-form.firebasestorage.app",
                messagingSenderId: "83776300208",
                appId: "1:83776300208:web:c52616cc14c3c85a664775"
            };

            // This appId is used in the Firestore collection path.
            // Using projectId for consistency in collection paths.
            const appId = firebaseConfig.projectId;

            try {
                // Attempt to initialize Firebase with the provided configuration
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                firebaseInitialized = true;
                console.log("Firebase initialized with provided config.");

                // Authenticate user only if Firebase is initialized
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with Firebase. User ID:", userId);
                    } else {
                        try {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                            console.log("Signed in anonymously. User ID:", userId);
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                            showMessage("Authentication failed. Check your Firebase project settings (Auth, Rules).", true);
                        }
                    }
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                // Catch any errors during the initializeApp call itself
                showMessage("Error initializing Firebase. Saving/viewing orders disabled. Check console for details.", true);
            }

            // Configuration for your company details and product categories
            const COMPANY_EMAIL = "shobhavatjewels@gmail.com";
            const COMPANY_INSTAGRAM = "@shobhavatjewels";
            const JEWELLERY_CATEGORIES = [
                "SET",
                "LONG SET",
                "KADA",
                "MALA",
                "CHAIN 18CT",
                "HAAR TOPS 18CT",
                "BRACELET 18CT",
                "RINGS 18CT",
                "KADA 18CT",
                "TEMPLE",
                "OTHER",
            ];

            // Update company info display
            document.getElementById('companyEmailDisplay').textContent = COMPANY_EMAIL;
            document.getElementById('companyEmailDisplay').href = `mailto:${COMPANY_EMAIL}`;
            document.getElementById('companyInstagramDisplay').textContent = COMPANY_INSTAGRAM;
            document.getElementById('companyInstagramDisplay').href = `https://instagram.com/${COMPANY_INSTAGRAM.replace('@', '')}`;


            const orderItemsTableBody = document.getElementById('orderItemsTableBody');
            const addItemBtn = document.getElementById('addItemBtn');
            const submitOrderBtn = document.getElementById('submitOrderBtn');
            const resetFormBtn = document.getElementById('resetFormBtn');
            const saveOrderBtn = document.getElementById('saveOrderBtn'); // New save button
            const viewOrdersBtn = document.getElementById('viewOrdersBtn'); // New view button
            const orderSummaryModal = document.getElementById('orderSummaryModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const modalContent = document.getElementById('modalContent');
            const printOrderBtn = document.getElementById('printOrderBtn');
            const savedOrdersModal = document.getElementById('savedOrdersModal'); // Saved orders modal
            const closeSavedOrdersModalBtn = document.getElementById('closeSavedOrdersModalBtn'); // Close saved orders modal button
            const savedOrdersList = document.getElementById('savedOrdersList'); // Div to list saved orders

            /**
             * Formats a date string (YYYY-MM-DD) into DD MON YYYY (e.g., 15 JUL 2025).
             * @param {string} dateString The date string in YYYY-MM-DD format.
             * @returns {string} The formatted date string or 'N/A' if invalid.
             */
            function formatDateForDisplay(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'N/A'; // Invalid date
                }
                const day = date.getDate().toString().padStart(2, '0');
                const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                return `${day} ${month} ${year}`;
            }

            /**
             * Populates the category dropdown with options.
             * @param {HTMLElement} selectElement The select element to populate.
             */
            function populateCategoryDropdown(selectElement) {
                selectElement.innerHTML = '<option value="">Select Category</option>'; // Default option
                JEWELLERY_CATEGORIES.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    selectElement.appendChild(option);
                });
            }

            /**
             * Adds event listeners to a new item row for dynamic removal.
             * @param {HTMLElement} row The new row element.
             */
            function setupRowListeners(row) {
                const removeItemBtn = row.querySelector('.remove-item-btn');
                const categorySelect = row.querySelector('.item-category');

                // Populate the dropdown for the new row
                populateCategoryDropdown(categorySelect);

                removeItemBtn.addEventListener('click', () => {
                    if (document.querySelectorAll('.item-row').length > 1) {
                        row.remove();
                    } else {
                        // If only one row remains, clear fields instead of removing
                        categorySelect.value = '';
                        row.querySelector('.item-jewellery-no').value = '';
                    }
                });
            }

            /**
             * Adds a new item row to the table.
             */
            function addNewItemRow() {
                const newRow = document.createElement('tr');
                newRow.classList.add('item-row');
                newRow.innerHTML = `
                    <td class="table-cell border-right-gray pr-4">
                        <select class="select-field item-category">
                            <!-- Options populated by JS -->
                        </select>
                    </td>
                    <td class="table-cell pl-4">
                        <input type="text" class="input-field item-jewellery-no" placeholder="e.g., JWR002">
                    </td>
                    <td class="table-cell text-center">
                        <button type="button" class="btn-danger remove-item-btn">Remove</button>
                    </td>
                `;
                orderItemsTableBody.appendChild(newRow);
                setupRowListeners(newRow);
            }

            /**
             * Displays the order summary in a modal.
             */
            function displayOrderSummary() {
                const clientName = document.getElementById('clientName').value || 'N/A';
                const orderDateRaw = document.getElementById('orderDate').value;
                const requiredByDateRaw = document.getElementById('requiredByDate').value;

                const orderDate = formatDateForDisplay(orderDateRaw);
                const requiredByDate = formatDateForDisplay(requiredByDateRaw);

                let itemsSummary = '';
                document.querySelectorAll('.item-row').forEach((row) => {
                    const itemCategory = row.querySelector('.item-category').value || 'Unspecified Category';
                    const jewelleryNo = row.querySelector('.item-jewellery-no').value || 'N/A';
                    itemsSummary += `
                        <div class="flex justify-between flex-wrap">
                            <span class="font-semibold">${itemCategory} (No: ${jewelleryNo})</span>
                        </div>
                    `;
                });

                modalContent.innerHTML = `
                    <p class="print-client-info"><span class="font-semibold">Client Name:</span> ${clientName}</p>
                    <p class="print-client-info"><span class="font-semibold">Order Date:</span> ${orderDate}</p>
                    <p class="print-client-info"><span class="font-semibold">Required By:</span> ${requiredByDate}</p>
                    <h3 class="print-items-heading">Items:</h3>
                    <div class="pl-4 space-y-1">${itemsSummary}</div>
                    <hr class="my-4 border-gray-200">
                `;
                orderSummaryModal.classList.remove('hidden'); // Ensure the modal is shown
            }

            /**
             * Resets the form to its initial state.
             */
            function resetForm() {
                document.getElementById('clientName').value = '';
                document.getElementById('orderDate').value = '';
                document.getElementById('requiredByDate').value = '';

                // Clear all existing item rows except the first one
                while (orderItemsTableBody.children.length > 1) {
                    orderItemsTableBody.removeChild(orderItemsTableBody.lastChild);
                }
                // Reset the first row
                const firstRow = orderItemsTableBody.querySelector('.item-row');
                firstRow.querySelector('.item-category').value = '';
                firstRow.querySelector('.item-jewellery-no').value = '';
                setupRowListeners(firstRow); // Re-setup listeners for the reset first row
            }

            /**
             * Sanitizes a string to be a valid Firestore document ID.
             * Removes invalid characters and replaces spaces with hyphens.
             * @param {string} name The string to sanitize.
             * @returns {string} The sanitized string.
             */
            function sanitizeDocId(name) {
                return name.replace(/[^a-zA-Z0-9-_. ]/g, '').replace(/\s+/g, '-').toLowerCase();
            }

            /**
             * Saves the current form data to Firestore.
             */
            async function saveOrder() {
                if (!firebaseInitialized || !userId) {
                    showMessage("Firebase is not active or user not authenticated. Cannot save order. Please configure Firebase.", true);
                    return;
                }

                const clientName = document.getElementById('clientName').value.trim();
                const orderDate = document.getElementById('orderDate').value;
                const requiredByDate = document.getElementById('requiredByDate').value;

                if (!clientName) {
                    showMessage("Client Name is required to save the order.", true);
                    return;
                }

                const items = [];
                document.querySelectorAll('.item-row').forEach(row => {
                    const itemCategory = row.querySelector('.item-category').value.trim();
                    const jewelleryNo = row.querySelector('.item-jewellery-no').value.trim();
                    if (itemCategory || jewelleryNo) { // Only save if at least one field is filled for the item
                        items.push({
                            category: itemCategory,
                            jewelleryNo: jewelleryNo
                        });
                    }
                });

                if (items.length === 0) {
                    showMessage("Please add at least one item to the order before saving.", true);
                    return;
                }

                // Create a unique document ID using client name and a timestamp for uniqueness
                const docId = `${sanitizeDocId(clientName)}-${Date.now()}`;
                const collectionPath = `artifacts/${appId}/users/${userId}/clientOrders`;

                const orderData = {
                    clientName: clientName,
                    orderDate: orderDate,
                    requiredByDate: requiredByDate,
                    items: items,
                    timestamp: new Date() // Add a timestamp for ordering/tracking
                };

                try {
                    await setDoc(doc(db, collectionPath, docId), orderData);
                    showMessage(`Order for "${clientName}" saved successfully!`);
                    resetForm(); // Optionally reset the form after saving
                } catch (e) {
                    console.error("Error saving document: ", e);
                    showMessage("Error saving order. Please check your Firebase configuration and security rules.", true);
                }
            }

            /**
             * Fetches and displays all saved orders from Firestore.
             */
            async function viewSavedOrders() {
                if (!firebaseInitialized || !userId) {
                    showMessage("Firebase is not active or user not authenticated. Cannot view orders. Please configure Firebase.", true);
                    return;
                }

                savedOrdersList.innerHTML = '<p class="text-center text-gray-500">Loading orders...</p>';
                savedOrdersModal.classList.remove('hidden');

                const collectionPath = `artifacts/${appId}/users/${userId}/clientOrders`;
                const ordersCollection = collection(db, collectionPath);
                const q = query(ordersCollection); // No orderBy to avoid index issues, sort in JS

                try {
                    const querySnapshot = await getDocs(q);
                    const orders = [];
                    querySnapshot.forEach((doc) => {
                        orders.push({ id: doc.id, ...doc.data() });
                    });

                    if (orders.length === 0) {
                        savedOrdersList.innerHTML = '<p class="text-center text-gray-500">No saved orders found.</p>';
                        return;
                    }

                    // Sort orders by timestamp (most recent first)
                    orders.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());

                    savedOrdersList.innerHTML = ''; // Clear loading message

                    orders.forEach(order => {
                        const orderElement = document.createElement('div');
                        orderElement.classList.add('p-3', 'border-b', 'border-gray-200', 'cursor-pointer', 'hover:bg-gray-50', 'rounded-md');
                        orderElement.innerHTML = `
                            <p class="font-semibold text-gray-800">Client: ${order.clientName}</p>
                            <p class="text-sm text-gray-600">Order Date: ${formatDateForDisplay(order.orderDate)}</p>
                            <p class="text-sm text-gray-600">Required By: ${formatDateForDisplay(order.requiredByDate)}</p>
                            <p class="text-xs text-gray-500 mt-1">Items: ${order.items.length}</p>
                        `;
                        orderElement.addEventListener('click', () => {
                            // Populate the main form with the selected order's data
                            document.getElementById('clientName').value = order.clientName;
                            document.getElementById('orderDate').value = order.orderDate;
                            document.getElementById('requiredByDate').value = order.requiredByDate;

                            // Clear existing items and add new ones
                            while (orderItemsTableBody.children.length > 0) {
                                orderItemsTableBody.removeChild(orderItemsTableBody.lastChild);
                            }
                            order.items.forEach(item => {
                                addNewItemRow(); // Adds a new row and populates dropdown
                                const lastRow = orderItemsTableBody.lastChild;
                                lastRow.querySelector('.item-category').value = item.category;
                                lastRow.querySelector('.item-jewellery-no').value = item.jewelleryNo;
                            });
                            // Ensure there's always at least one empty row if the loaded order had no items
                            if (order.items.length === 0) {
                                addNewItemRow();
                            }

                            savedOrdersModal.classList.add('hidden'); // Close the view modal
                            showMessage(`Order for "${order.clientName}" loaded.`);
                            displayOrderSummary(); // Show the order summary modal after loading
                        });
                        savedOrdersList.appendChild(orderElement);
                    });

                } catch (e) {
                    console.error("Error fetching documents: ", e);
                    savedOrdersList.innerHTML = '<p class="text-center text-red-500">Error loading orders.</p>';
                    showMessage("Error loading orders. Please check your Firebase configuration and security rules.", true);
                }
            }


            // Initial setup for the first row
            const initialRow = orderItemsTableBody.querySelector('.item-row');
            setupRowListeners(initialRow);

            // Event Listeners
            addItemBtn.addEventListener('click', addNewItemRow);
            submitOrderBtn.addEventListener('click', displayOrderSummary);
            resetFormBtn.addEventListener('click', resetForm);
            saveOrderBtn.addEventListener('click', saveOrder); // Event listener for new save button
            viewOrdersBtn.addEventListener('click', viewSavedOrders); // Event listener for new view button
            closeModalBtn.addEventListener('click', () => {
                orderSummaryModal.classList.add('hidden');
            });
            closeSavedOrdersModalBtn.addEventListener('click', () => {
                savedOrdersModal.classList.add('hidden');
            });
            printOrderBtn.addEventListener('click', async () => { // Made async
                console.log("Print button clicked."); // Debugging log
                let printWindow = null;
                try {
                    printWindow = window.open('', '_blank', 'height=600,width=800');
                    if (!printWindow) {
                        showMessage("🚨 Pop-up blocked! Please allow pop-ups for this site to print. 🚨", true);
                        console.error("Print window could not be opened. Pop-up blocker likely active.");
                        return;
                    }

                    // Get the order summary content from the modal (which now excludes contact info)
                    const clientName = document.getElementById('clientName').value || 'N/A';
                    const orderDateRaw = document.getElementById('orderDate').value;
                    const requiredByDateRaw = document.getElementById('requiredByDate').value;

                    const orderDate = formatDateForDisplay(orderDateRaw);
                    const requiredByDate = formatDateForDisplay(requiredByDateRaw);

                    let itemsSummaryHtml = '';
                    document.querySelectorAll('.item-row').forEach((row) => {
                        const itemCategory = row.querySelector('.item-category').value || 'Unspecified Category';
                        const jewelleryNo = row.querySelector('.item-jewellery-no').value || 'N/A';
                        itemsSummaryHtml += `
                            <div class="flex justify-between flex-wrap">
                                <span class="print-item-line font-semibold">${itemCategory} (No: ${jewelleryNo})</span>
                            </div>
                        `;
                    });

                    // Build the full HTML content for the print window
                    let printContentHtml = `
                        <html>
                        <head>
                            <title>Order Summary</title>
                            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
                            <style>
                                body {
                                    font-family: 'Inter', sans-serif;
                                    background-color: #FFFFFF !important; /* Changed to white for better print readability */
                                    color: #333333; /* Darkened text color */
                                    margin: 0;
                                    padding: 0.5rem 1.5rem; /* Reduced top padding */
                                    min-height: 100vh;
                                    box-sizing: border-box;
                                    overflow: visible; /* Allow content to overflow for printing */
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: flex-start;
                                    padding-bottom: 5rem; /* Space for fixed footer */
                                }
                                /* Ensure all text elements inherit the dark color */
                                p, span, h2, h3, label {
                                    color: #333333 !important; /* Force dark text */
                                    margin: 0 !important; /* Zero margins */
                                    padding: 0 !important; /* Zero padding */
                                }
                                .font-semibold {
                                    color: #333333 !important; /* Force dark text */
                                }

                                /* Header styles - unchanged as per user */
                                .company-name {
                                    font-family: 'Dancing Script', cursive;
                                    color: #CD853F !important; /* Darkened color for Shobhavat Jewels */
                                    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                                    font-size: 1.5rem !important; /* Significantly reduced */
                                    line-height: 1.2 !important; /* Reduced line height */
                                    text-transform: capitalize;
                                    text-align: center; /* Ensure it's centered in print */
                                    margin-bottom: 0 !important; /* Zero margin bottom */
                                }
                                .tagline {
                                    font-family: 'Inter', sans-serif;
                                    color: #FFD700 !important; /* Gold */
                                    margin-top: 0 !important; /* Zero margin top */
                                    font-size: 0.6rem !important; /* Significantly reduced */
                                    text-align: center; /* Ensure it's centered in print */
                                    margin-bottom: 0.5rem !important; /* Small margin bottom for spacing from next section */
                                    line-height: 1.2 !important; /* Reduced line height */
                                }
                                .event-title {
                                    font-family: 'Inter', sans-serif;
                                    font-weight: 700;
                                    color: #333333 !important; /* Darkened text */
                                    text-transform: uppercase;
                                    font-size: 0.8rem !important; /* Significantly reduced */
                                    margin-bottom: 0 !important; /* Zero margin bottom */
                                    line-height: 1.2 !important; /* Reduced line height */
                                    text-align: center;
                                }
                                .form-subtitle {
                                    font-family: 'Inter', sans-serif;
                                    font-weight: 600;
                                    color: #333333 !important; /* Darkened text */
                                    text-transform: uppercase;
                                    font-size: 0.7rem !important; /* Significantly reduced */
                                    margin-top: 0 !important; /* Zero margin top */
                                    margin-bottom: 0.5rem !important; /* Reduced margin bottom */
                                    text-align: center;
                                    line-height: 1.2 !important; /* Reduced line height */
                                }

                                /* Circled area content - FONT SIZE AND SPACING ADJUSTMENTS */
                                .print-client-info { /* Client Name, Order Date, Required By */
                                    font-size: 13.3848px !important; /* 11.154px * 1.20 */
                                    line-height: 1.5 !important;
                                    margin-bottom: 0 !important; /* Ensure minimal space between these lines */
                                }
                                .print-client-info:last-of-type { /* Targets the last <p> which is "Required By" */
                                    margin-bottom: 0.5rem !important; /* Reduced space below "Required By" */
                                }

                                .print-items-heading { /* Items heading */
                                    font-size: 15.8184px !important; /* 13.182px * 1.20 */
                                    margin-top: 0.5rem !important; /* Moved up significantly */
                                    margin-bottom: 0.5rem !important;
                                    line-height: 1.5 !important;
                                }

                                .print-item-line { /* Individual item lines (span inside pl-4) */
                                    font-size: 12.168px !important; /* 10.14px * 1.20 */
                                    line-height: 1.5 !important;
                                    margin-bottom: 0 !important;
                                }


                                /* Footer styles - unchanged as per user */
                                .print-footer-container {
                                    position: fixed;
                                    bottom: 0;
                                    left: 0;
                                    width: 100%;
                                    background-color: #FFFFFF !important; /* Match the print background color */
                                    padding: 0.5rem 1.5rem !important; /* Consistent padding */
                                    box-sizing: border-box;
                                    z-index: 1000;
                                    border-top: 1px solid rgba(0, 0, 0, 0.2) !important; /* Darker border for white background */
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: flex-end;
                                }
                                .print-contact-left, .print-contact-right {
                                    display: flex;
                                    flex-direction: column;
                                    color: #333333 !important; /* Darkened text */
                                }
                                .print-contact-left { text-align: left; }
                                .print-contact-right { text-align: right; }
                                .print-contact-heading {
                                    font-size: 0.3198832rem !important;
                                    margin-bottom: 0.08rem !important;
                                    line-height: 1.2 !important;
                                }
                                .print-contact-line {
                                    font-size: 7.311616px !important;
                                    margin: 0 !important;
                                    padding: 0 !important;
                                    line-height: 1.2 !important;
                                }
                                .company-info-link { color: #FBBF24 !important; text-decoration: none; }
                                .company-info-link:hover { text-decoration: underline; }
                            </style>
                        </head>
                        <body>
                            <h1 class="company-name">Shobhavat Jewels</h1>
                            <p class="tagline">Timeless Treasures For The Modern Soul</p>
                            <h2 class="event-title">IIJS PREMIER 2025</h2>
                            <h3 class="form-subtitle">Client Order Form</h3>

                            <!-- Client Info and Items Section -->
                            <p class="print-client-info"><span class="font-semibold">Client Name:</span> ${clientName}</p>
                            <p class="print-client-info"><span class="font-semibold">Order Date:</span> ${orderDate}</p>
                            <p class="print-client-info"><span class="font-semibold">Required By:</span> ${requiredByDate}</p>
                            <h3 class="print-items-heading">Items:</h3>
                            <div class="pl-4 space-y-1">${itemsSummaryHtml}</div>
                            <hr class="my-4 border-gray-200">

                            <div class="print-footer-container">
                                <div class="print-contact-left">
                                    <p class="print-contact-heading">For inquiries, contact us:</p>
                                    <p class="print-contact-line">Harish Jain: 9820577028</p>
                                    <p class="print-contact-line">Kishore Jain: 9004548007</p>
                                    <p class="print-contact-line">Mahipal Jain: 9819656413</p>
                                </div>
                                <div class="print-contact-right">
                                    <p class="print-contact-line">Email: shobhavatjewels@gmail.com</p>
                                    <p class="print-contact-line">Instagram: @shobhavatjewels</p>
                                </div>
                            </div>
                        </body>
                        </html>
                    `;

                    printWindow.document.write(printContentHtml);
                    printWindow.document.close();
                    printWindow.focus(); // Focus the new window
                    // Give a small delay to ensure content is rendered before printing
                    await new Promise(resolve => setTimeout(resolve, 500)); // 500ms delay
                    printWindow.print();
                    printWindow.onafterprint = () => printWindow.close(); // Close after printing
                    console.log("Print initiated.");
                } catch (error) {
                    console.error("Error during print:", error);
                    showMessage("Could not open print preview. Please check your browser's pop-up blocker and try again.", true);
                }
            });
        });
    </script>
</body>
</html>
